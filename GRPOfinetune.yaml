name: GRPOfinetune
description: Trains a LoRA fine-tuned model using GRPO with Unsloth for tool-calling improvement

inputs:
  - {name: base_model_name, type: String}
  - {name: lora_adapters, type: Model}
  - {name: dataset, type: Dataset}
  - {name: max_seq_length, type: Integer}
  - {name: lora_rank, type: Integer}
  - {name: learning_rate, type: Float}
  - {name: num_train_steps, type: Integer}
  - {name: batch_size, type: Integer}
  - {name: grad_accum_steps, type: Integer}
  - {name: num_generations, type: Integer}
  - {name: temperature, type: Float}
  - {name: tool_call_start, type: String}
  - {name: tool_call_end, type: String}
  - {name: think_start, type: String}
  - {name: think_end, type: String}
  - {name: custom_chat_template, type: String}

outputs:
  - {name: grpo_model, type: Model}



implementation:
  container:
    image: gurpreetgandhi/nesy-factory:v24-gpu
    command:
      - sh
      - -c
      - |
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import os
        import torch
        import re
        import numpy as np
        from datasets import load_dataset, Dataset
        from unsloth import FastLanguageModel
        from vllm import SamplingParams
        from trl import GRPOConfig, GRPOTrainer
        import argparse
        import json
        import pickle

        
    args:
      - --base_model_name
      - {inputValue: base_model_name}
      - --lora_adapters
      - {inputPath: lora_adapters}
      - --dataset
      - {inputPath: dataset}
      - --max_seq_length
      - {inputValue: max_seq_length}
      - --lora_rank
      - {inputValue: lora_rank}
      - --learning_rate
      - {inputValue: learning_rate}
      - --num_train_steps
      - {inputValue: num_train_steps}
      - --batch_size
      - {inputValue: batch_size}
      - --grad_accum_steps
      - {inputValue: grad_accum_steps}
      - --num_generations
      - {inputValue: num_generations}
      - --temperature
      - {inputValue: temperature}
      - --tool_call_start
      - {inputValue: tool_call_start}
      - --tool_call_end
      - {inputValue: tool_call_end}
      - --think_start
      - {inputValue: think_start}
      - --think_end
      - {inputValue: think_end}
      - --custom_chat_template
      - {inputValue: custom_chat_template}
      - --grpo_model
      - {outputPath: grpo_model}
