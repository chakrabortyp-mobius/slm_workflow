name: CDN Download 2
description: Downloads config.properties and mpqe.mar files from CDN URLs and saves them locally with proper directory structure.
inputs:
  - {name: model_url, type: String, description: "URL to fetch the mpqe.mar model file from"}
outputs:
  - {name: model_file, type: Data, description: "Downloaded mpqe.mar model file"}
implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests || \
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests --user
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import os
        import requests

        parser = argparse.ArgumentParser()

        parser.add_argument('--model_url', type=str, required=True)
        parser.add_argument('--model_file', type=str, required=True)
        args = parser.parse_args()

        
        print("Received model_url:", args.model_url)

        try:

            # Download mpqe.mar model file
            print("Fetching mpqe.mar model from CDN:", args.model_url)
            resp_model = requests.get(args.model_url, timeout=300)
            resp_model.raise_for_status()
            
            os.makedirs(args.model_file, exist_ok=True)
            model_path = os.path.join(args.model_file, 'data.csv')
            with open(model_path, "wb") as f:
                f.write(resp_model.content)
            print("Model file saved at:", model_path)
            print("Model size:", len(resp_model.content), "bytes")



        except requests.exceptions.Timeout:
            print("Error: Request timed out while downloading from CDN")
            exit(1)
        except requests.exceptions.RequestException as e:
            print("Error: Network error during download:", str(e))
            exit(1)
        except Exception as e:
            print("Error: Failed to download files:", str(e))
            import traceback
            traceback.print_exc()
            exit(1)
    args:
      - --model_url
      - {inputValue: model_url}
      - --model_file
      - {outputPath: model_file}
