name: CDN Download CSV Filehh
description: Downloads a CSV file from a CDN URL and saves it locally with proper directory structure.
inputs:
  - {name: csv_url, type: String, description: "URL to fetch the CSV file from"}
outputs:
  - {name: csv_file, type: String, description: "Downloaded CSV file"}
implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests || \
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests --user
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import os
        import requests
        
        parser = argparse.ArgumentParser()
        parser.add_argument('--csv_url', type=str, required=True)
        parser.add_argument('--csv_file', type=str, required=True)
        
        args = parser.parse_args()
        
        print("Received csv_url:", args.csv_url)
        
        try:
            # Download CSV file
            print("Fetching CSV file from CDN:", args.csv_url)
            resp_csv = requests.get(args.csv_url, timeout=120)
            resp_csv.raise_for_status()
            
            os.makedirs(args.csv_file, exist_ok=True)
            csv_path = os.path.join(args.csv_file, 'data.csv')
            with open(csv_path, "w") as f:
                f.write(resp_csv.text)
            print("CSV file saved at:", csv_path)
            print("CSV size:", len(resp_csv.text), "characters")
            
            print("File downloaded successfully!")
            print("Output structure:")
            print("  - csv_file/data.csv")
            
            # Verify file exists and has content
            if os.path.exists(csv_path) and os.path.getsize(csv_path) > 0:
                print("data.csv downloaded and verified")
            else:
                raise Exception("data.csv download verification failed")
                
        except requests.exceptions.Timeout:
            print("Error: Request timed out while downloading from CDN")
            exit(1)
        except requests.exceptions.RequestException as e:
            print("Error: Network error during download:", str(e))
            exit(1)
        except Exception as e:
            print("Error: Failed to download file:", str(e))
            import traceback
            traceback.print_exc()
            exit(1)

    args:
      - --csv_url
      - {inputValue: csv_url}
      - --csv_file
      - {outputPath: csv_file}
